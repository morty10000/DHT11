<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸©æ¹¿åº¦ä»ªè¡¨ç›˜</title>
    <link rel="stylesheet" href="mystyle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <!-- ä¼ æ„Ÿå™¨æ•°æ®å®¹å™¨ -->
    <div class="sensor-container">
        <!-- æ¸©åº¦ç›‘æµ‹æ¨¡å— -->
        <div class="data-box temperature-box">
            <h2>ğŸŒ¡ï¸ æ¸©åº¦ç›‘æµ‹</h2>
            <div class="gauge-container">
                <div class="gauge-background temperature-gauge">
                    <div class="gauge-pointer" id="temp-pointer"></div>
                    <div class="gauge-center"></div>
                </div>
            </div>
            <div class="data-value">
                <span id="temp-value">--</span><span class="unit">Â°C</span>
            </div>
        </div>

        <!-- æ¹¿åº¦ç›‘æµ‹æ¨¡å— -->
        <div class="data-box humidity-box">
            <h2>ğŸ’§ æ¹¿åº¦ç›‘æµ‹</h2>
            <div class="gauge-container">
                <div class="gauge-background humidity-gauge">
                    <div class="gauge-pointer" id="humi-pointer"></div>
                    <div class="gauge-center"></div>
                </div>
            </div>
            <div class="data-value">
                <span id="humi-value">--</span><span class="unit">%</span>
            </div>
        </div>
    </div>

    <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
    <div class="connection-status">
        <div class="status-indicator">
            <span class="status-dot"></span>
            <span id="status-text">æ­£åœ¨åˆå§‹åŒ–...</span>
        </div>
        <div class="status-details">
            <div>Topic: <span id="current-topic">/k1ou2S5PFlX/stm32/user/update</span></div>
            <div>æœ€åæ›´æ–°: <span id="last-update">--:--:--</span></div>
        </div>
    </div>

    <script>
        // ä»ªè¡¨é…ç½®
        const config = {
            temperature: {
                min: -10,
                max: 50,
                pointer: document.getElementById('temp-pointer'),
                valueElement: document.getElementById('temp-value')
            },
            humidity: {
                min: 0,
                max: 100,
                pointer: document.getElementById('humi-pointer'),
                valueElement: document.getElementById('humi-value')
            }
        };
        
        // é˜¿é‡Œäº‘é…ç½®
        const aliyunConfig = {
            productKey: "k1ou2S5PFlX",
            deviceName: "html",
            deviceSecret: "023760c4d05a5cf5c959a94e832d6c33",
            regionId: "cn-shanghai",
            topic: "/sys/k1ou2S5PFlX/html/thing/deviceinfo/update"
        };

        // çŠ¶æ€ç®¡ç†
        let mqttClient = null;

        /**
 * åˆ›å»ºä»ªè¡¨ç›˜åˆ»åº¦çº¿å’Œæ•°å€¼æ ‡ç­¾
 * @param {HTMLElement} container - ä»ªè¡¨å®¹å™¨å…ƒç´ 
 * @param {boolean} isTemperature - æ˜¯å¦ä¸ºæ¸©åº¦ä»ªè¡¨
 */
function createScaleMarks(container, isTemperature) {
    const radius = 100;  // å®¹å™¨åŠå¾„ï¼ˆä¸CSSä¸­gauge-containerå°ºå¯¸ä¸€è‡´ï¼‰
    const totalMarks = 10; // ä¸»åˆ»åº¦æ•°é‡
    const startAngle = isTemperature ? -45 : -135; // æ¸©åº¦èµ·å§‹-45Â°ï¼Œæ¹¿åº¦èµ·å§‹-135Â°
    const angleStep = 27; // æ¯ä¸ªåˆ»åº¦é—´éš”è§’åº¦ï¼ˆ270Â°èŒƒå›´ / 10ä¸ªé—´éš”ï¼‰

    // å¾ªç¯åˆ›å»ºæ‰€æœ‰åˆ»åº¦
    for (let i = 0; i <= totalMarks; i++) {
        const currentAngle = startAngle + (i * angleStep);
        
        // åˆ›å»ºåˆ»åº¦çº¿å…ƒç´ 
        const mark = document.createElement('div');
        mark.className = 'gauge-mark';
        
        // è®¡ç®—åˆ»åº¦çº¿åæ ‡ï¼ˆä»åœ†å¿ƒå‘å¤–åç§»5pxï¼‰
        const x = radius + (radius - 5) * Math.sin(currentAngle * Math.PI / 180);
        const y = radius - (radius - 5) * Math.cos(currentAngle * Math.PI / 180);

        // è®¾ç½®åˆ»åº¦çº¿æ ·å¼
        mark.style.cssText = `
            left: ${x}px;
            top: ${y}px;
            transform: rotate(${currentAngle}deg);
        `;

        // å¢å¼ºé¦–å°¾åˆ»åº¦çº¿
        if(i === 0 || i === totalMarks) {
            mark.style.height = '16px';
            mark.style.background = '#444';
        }
        container.appendChild(mark);

        // æ¯éš”2ä¸ªåˆ»åº¦æ·»åŠ æ•°å€¼æ ‡ç­¾
        if(i % 2 === 0) {
            const label = document.createElement('div');
            label.className = 'gauge-label';
            
            // è®¡ç®—æ ‡ç­¾æ•°å€¼
            const value = isTemperature 
                ? config.temperature.min + (i * 6) // æ¸©åº¦æ¯åˆ»åº¦+6Â°Cï¼ˆ-10, -4, 2...50ï¼‰
                : i * 10; // æ¹¿åº¦æ¯åˆ»åº¦+10%ï¼ˆ0, 20, 40...100ï¼‰
            
            label.textContent = value;
            
            // è°ƒæ•´æ ‡ç­¾ä½ç½®ï¼ˆå‘å¤–åç§»10pxï¼‰
            const labelX = radius + (radius - 10) * Math.sin(currentAngle * Math.PI / 180);
            const labelY = radius - (radius - 10) * Math.cos(currentAngle * Math.PI / 180);
            
            label.style.left = `${labelX}px`;
            label.style.top = `${labelY}px`;
            container.appendChild(label);
        }
    }
}

/**
 * æ›´æ–°ä»ªè¡¨æ˜¾ç¤º
 * @param {Object} sensorConfig - ä¼ æ„Ÿå™¨é…ç½®å¯¹è±¡
 * @param {number} value - å½“å‰æµ‹é‡å€¼
 */
function updateGauge(sensorConfig, value) {
    // æ•°å€¼è¾¹ç•Œé™åˆ¶ï¼ˆä¿æŒåœ¨å®é™…é‡ç¨‹èŒƒå›´å†…ï¼‰
    value = Math.max(sensorConfig.min, Math.min(sensorConfig.max, value));
    
    // è®¡ç®—æŒ‡é’ˆæ—‹è½¬è§’åº¦
    const range = sensorConfig.max - sensorConfig.min;
    let angle;
    
    // æ¸©åº¦ï¼š-45Â°ï¼ˆ-10Â°Cï¼‰åˆ° 225Â°ï¼ˆ50Â°Cï¼‰
    // æ¹¿åº¦ï¼š-135Â°ï¼ˆ0%ï¼‰åˆ° 135Â°ï¼ˆ100%ï¼‰
    if (sensorConfig === config.temperature) {
        angle = ((value - sensorConfig.min) / range) * 270 - 45;
    } else {
        angle = ((value - sensorConfig.min) / range) * 270 - 135;
    }
    
    // åº”ç”¨æŒ‡é’ˆæ—‹è½¬åŠ¨ç”»
    sensorConfig.pointer.style.transform = `rotate(${angle}deg)`;
    
    // æ›´æ–°æ•°å€¼æ˜¾ç¤ºï¼ˆä¿ç•™ä¸€ä½å°æ•°ï¼‰
    sensorConfig.valueElement.textContent = value.toFixed(1);
}

        // ç”ŸæˆMQTTé…ç½®
        function generateMqttConfig() {
            const { productKey, deviceName, deviceSecret } = aliyunConfig;
            const randomStr = Math.random().toString(16).substr(2, 6);
            const timestamp = Date.now();
            const clientId = `${productKey}.${deviceName}|securemode=3,signmethod=hmacsha1,timestamp=${timestamp}|${randomStr}`;
            
            const signContent = [
                `clientId${clientId}`,
                `deviceName${deviceName}`,
                `productKey${productKey}`,
                `timestamp${timestamp}`
            ].join('');

            try {
                const sign = CryptoJS.HmacSHA1(signContent, deviceSecret)
                    .toString(CryptoJS.enc.Hex);
                
                return {
                    host: 'iot-06z00huu9u3ft33.mqtt.iothub.aliyuncs.com',
                    port: 1883,
                    clientId,
                    username: `${deviceName}&${productKey}`,
                    password: `version=2018-10-15&res=products/${productKey}/devices/${deviceName}&signmethod=hmacsha1&sign=${sign}`,
                    protocol: 'wss',
                    reconnectPeriod: 5000,
                    connectTimeout: 10000
                };
            } catch (error) {
                console.error('é…ç½®ç”Ÿæˆå¤±è´¥:', error);
                updateStatus('å®‰å…¨è®¤è¯å¤±è´¥', 'error');
                throw error;
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(text, statusClass) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('status-text');
            
            statusDot.className = `status-dot status-${statusClass}`;
            statusText.textContent = text;
            
            // æ·»åŠ å‘¼å¸åŠ¨ç”»
            statusDot.style.animation = statusClass === 'connecting' 
                ? 'breath 1.5s infinite' 
                : 'none';
        }

        // æ›´æ–°æœ€åé€šè®¯æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            document.getElementById('last-update').textContent = timeString;
        }

        // è¿æ¥é˜¿é‡Œäº‘
        function connectAliyunIoT() {
            try {
                const mqttConfig = generateMqttConfig();
                mqttClient = mqtt.connect(mqttConfig);

                // è¿æ¥äº‹ä»¶
                mqttClient.on('connect', () => {
                    updateStatus('å·²è¿æ¥é˜¿é‡Œäº‘', 'connected');
                    mqttClient.subscribe(aliyunConfig.topic, { qos: 1 });
                });

                // æ¶ˆæ¯å¤„ç†
                mqttClient.on('message', (topic, message) => {
                    try {
                        const payload = JSON.parse(message.toString());
                        if (payload.temperature !== undefined) {
                            updateGauge(config.temperature, payload.temperature);
                        }
                        if (payload.humidity !== undefined) {
                            updateGauge(config.humidity, payload.humidity);
                        }
                        updateLastUpdateTime();
                    } catch (e) {
                        console.error('æ•°æ®è§£æé”™è¯¯:', e);
                    }
                });

                // é”™è¯¯å¤„ç†
                mqttClient.on('error', (err) => {
                    console.error('è¿æ¥é”™è¯¯:', err);
                    updateStatus(`è¿æ¥å¤±è´¥: ${err.message}`, 'error');
                });

                // é‡è¿å¤„ç†
                mqttClient.on('reconnect', () => {
                    updateStatus('å°è¯•é‡æ–°è¿æ¥...', 'connecting');
                });

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        window.onload = () => {
            createScaleMarks(document.querySelector('.temperature-gauge'), true);
            createScaleMarks(document.querySelector('.humidity-gauge'), false);
            connectAliyunIoT();
        }
    </script>
</body>
</html>