<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ä»ªè¡¨ç›˜</title>
    <link rel="stylesheet" href="mystyle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* æ·»åŠ å†…è”æ ·å¼é¿å…ä¿®æ”¹å¤–éƒ¨CSS */
        .data-display {
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #rawData {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <!-- åŸæœ‰ä¼ æ„Ÿå™¨æ•°æ®å®¹å™¨ -->
    <div class="sensor-container">
        <!-- æ¸©åº¦ç›‘æµ‹æ¨¡å— -->
        <div class="data-box temperature-box">
            <h2>ğŸŒ¡ï¸ æ¸©åº¦ç›‘æµ‹</h2>
            <div class="gauge-container">
                <div class="gauge-background temperature-gauge">
                    <div class="gauge-pointer" id="temp-pointer"></div>
                    <div class="gauge-center"></div>
                </div>
            </div>
            <div class="data-value">
                <span id="temp-value">--</span><span class="unit">Â°C</span>
            </div>
        </div>

        <!-- æ¹¿åº¦ç›‘æµ‹æ¨¡å— -->
        <div class="data-box humidity-box">
            <h2>ğŸ’§ æ¹¿åº¦ç›‘æµ‹</h2>
            <div class="gauge-container">
                <div class="gauge-background humidity-gauge">
                    <div class="gauge-pointer" id="humi-pointer"></div>
                    <div class="gauge-center"></div>
                </div>
            </div>
            <div class="data-value">
                <span id="humi-value">--</span><span class="unit">%</span>
            </div>
        </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <button class="btn connect-btn" onclick="connectDevice()">è¿æ¥è®¾å¤‡</button>
        <button class="btn disconnect-btn" onclick="disconnectDevice()">æ–­å¼€è¿æ¥</button>
        <button class="btn led-on" onclick="controlLED(1)">ğŸ’¡ æ‰“å¼€LED</button>
        <button class="btn led-off" onclick="controlLED(0)">ğŸ”Œ å…³é—­LED</button>
    </div>

    <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
    <div class="connection-status">
        <div class="status-indicator">
            <span class="status-dot"></span>
            <span id="status-text">ç­‰å¾…è¿æ¥...</span>
        </div>
        <div class="status-details">
            <div>Topic: <span id="current-topic">/sys/k1ou2S5PFlX/html/thing/service/property/set</span></div>
        </div>
    </div>

    <!-- æ–°å¢æ•°æ®å±•ç¤ºåŒºåŸŸ -->
    <div class="data-display">
        <h3>å®æ—¶æ•°æ®æµ</h3>
        <pre id="rawData">ç­‰å¾…æ•°æ®æ¥å…¥...</pre>
    </div>

    <script>
    //<----------------------ç½‘é¡µæ§åˆ¶led---------------------->//
    // æ·»åŠ LEDæ§åˆ¶å‡½æ•°
    function controlLED(state) {
    if (!mqttClient || !mqttClient.connected) {
        alert('è¯·å…ˆè¿æ¥è®¾å¤‡ï¼');
        return;
    }

    const payload = {
        method: "thing.service.property.set",
        id: Date.now().toString(),
        params: {
            LEDState: state
        },
        version: "1.0"
    };

    mqttClient.publish(aliyunConfig.publishTopic, JSON.stringify(payload), { qos: 1 }, (err) => {
        const action = state ? "å¼€å¯" : "å…³é—­";
        if (err) {
            updateStatus(`LED${action}æŒ‡ä»¤å‘é€å¤±è´¥`, 'error');
            console.error('å‘å¸ƒå¤±è´¥:', err);
        } else {
            updateStatus(`å·²å‘é€LED${action}æŒ‡ä»¤`, 'connected');
            // å°†æ§åˆ¶æŒ‡ä»¤æ˜¾ç¤ºåœ¨æ•°æ®æµä¸­
            dataCache.push(JSON.stringify(payload, null, 2));
            updateDataDisplay(dataCache);
        }
    });
    }
        //<----------------------ä»ªè¡¨é…ç½®---------------------->//
        // ä»ªè¡¨é…ç½®
        const config = {
            temperature: {
                min: -10,
                max: 50,
                pointer: document.getElementById('temp-pointer'),
                valueElement: document.getElementById('temp-value')
            },
            humidity: {
                min: 0,
                max: 100,
                pointer: document.getElementById('humi-pointer'),
                valueElement: document.getElementById('humi-value')
            }
        };
        //<----------------------ç½‘é¡µè¿æ¥é˜¿é‡Œäº‘é…ç½®---------------------->//
        // é˜¿é‡Œäº‘é…ç½®
        const aliyunConfig = {
            productKey: "k1ou2S5PFlX",
            deviceName: "html",
            deviceSecret: "023760c4d05a5cf5c959a94e832d6c33",
            host: "wss://iot-06z00huu9u3ft33.mqtt.iothub.aliyuncs.com:443/mqtt",
            subscribeTopic: "/sys/k1ou2S5PFlX/html/thing/service/property/set",
            publishTopic: "/k1ou2S5PFlX/html/thing/event/property/post" 
        };

        let mqttClient = null;
        let dataCache = [];

        // ç”ŸæˆåŠ¨æ€å¯†ç 
        function generatePassword(timestamp) {
            const content = [
                'clientId' + aliyunConfig.productKey + '.' + aliyunConfig.deviceName,
                'deviceName' + aliyunConfig.deviceName,
                'productKey' + aliyunConfig.productKey,
                'timestamp' + timestamp
            ].join('');

            return CryptoJS.HmacSHA256(content, aliyunConfig.deviceSecret).toString(CryptoJS.enc.Hex);
        }

        // è¿æ¥è®¾å¤‡
        function connectDevice() {
            if(mqttClient && mqttClient.connected) return;

            const timestamp = Date.now();
            const options = {
                clientId: `${aliyunConfig.productKey}.${aliyunConfig.deviceName}|securemode=2,signmethod=hmacsha256,timestamp=${timestamp}|`,
                username: `${aliyunConfig.deviceName}&${aliyunConfig.productKey}`,
                password: generatePassword(timestamp),
                clean: true,
                reconnectPeriod: 5000,
                connectTimeout: 30000
            };

            updateStatus('æ­£åœ¨è¿æ¥...', 'connecting');
            
            try {
                mqttClient = mqtt.connect(aliyunConfig.host, options);

                mqttClient.on('connect', () => {
                    updateStatus('å·²è¿æ¥è‡³é˜¿é‡Œäº‘', 'connected');
                    mqttClient.subscribe(aliyunConfig.subscribeTopic, { qos: 1 }, (err) => {
                        if (!err) {
                            console.log('æˆåŠŸè®¢é˜…:', aliyunConfig.subscribeTopic);
                            document.getElementById('current-topic').textContent = aliyunConfig.subscribeTopic;
                        }
                    });
                });

                mqttClient.on('message', (topic, message) => {
                    try {
                        const rawData = message.toString();
                        const payload = JSON.parse(rawData);
                        
                        // æ›´æ–°ä»ªè¡¨æ˜¾ç¤º
                        if (payload.items) {
                            if (typeof payload.items.temperature === 'number') {
                                updateGauge(config.temperature, payload.items.temperature);
                            }
                            if (typeof payload.items.humidity === 'number') {
                                updateGauge(config.humidity, payload.items.humidity);
                            }
                        }

                        // æ›´æ–°æ•°æ®å±•ç¤º
                        dataCache.push(rawData);
                        if(dataCache.length > 20) dataCache.shift();
                        updateDataDisplay(dataCache);
                    } catch (e) {
                        console.error('æ•°æ®è§£æé”™è¯¯:', e);
                        document.getElementById('rawData').textContent = `æ— æ•ˆæ•°æ®æ ¼å¼: ${rawData}`;
                    }
                });

                mqttClient.on('error', (error) => {
                    console.error('è¿æ¥é”™è¯¯:', error);
                    updateStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                });

                mqttClient.on('reconnect', () => {
                    updateStatus('å°è¯•é‡æ–°è¿æ¥...', 'connecting');
                });

                mqttClient.on('close', () => {
                    updateStatus('è¿æ¥å·²æ–­å¼€', 'disconnected');
                });

            } catch (error) {
                updateStatus(`è¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnectDevice() {
            if (mqttClient && mqttClient.connected) {
                mqttClient.end();
                updateStatus('å·²ä¸»åŠ¨æ–­å¼€', 'disconnected');
            }
        }

        // æ›´æ–°ä»ªè¡¨æŒ‡é’ˆ
        function updateGauge(sensorConfig, value) {
            value = Math.max(sensorConfig.min, Math.min(sensorConfig.max, value));
            const range = sensorConfig.max - sensorConfig.min;
            const angle = ((value - sensorConfig.min) / range) * 270 - (sensorConfig === config.temperature ? 45 : 135);
            
            sensorConfig.pointer.style.transform = `rotate(${angle}deg)`;
            sensorConfig.valueElement.textContent = value.toFixed(1);
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(text, statusClass) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('status-text');
            
            statusDot.className = `status-dot status-${statusClass}`;
            statusText.textContent = text;
            statusDot.style.animation = statusClass === 'connecting' 
                ? 'breath 1.5s infinite' 
                : 'none';
        }

        // æ›´æ–°æ•°æ®å±•ç¤º
        function updateDataDisplay(dataArray) {
            const formattedData = dataArray
                .map(data => {
                    try {
                        return JSON.stringify(JSON.parse(data), null, 2);
                    } catch {
                        return data;
                    }
                })
                .reverse()
                .join('\n\n');
            
            const display = document.getElementById('rawData');
            display.textContent = formattedData;
            display.scrollTop = 0; // ä¿æŒæœ€æ–°æ•°æ®åœ¨é¡¶éƒ¨
        }

        // åˆå§‹åŒ–ä»ªè¡¨åˆ»åº¦
        function createScaleMarks(container, isTemperature) {
            const radius = 100;
            const startAngle = isTemperature ? -45 : -135;
            const angleStep = 27;

            for (let i = 0; i <= 10; i++) {
                const currentAngle = startAngle + (i * angleStep);
                const mark = document.createElement('div');
                mark.className = 'gauge-mark';
                const x = radius + (radius - 5) * Math.sin(currentAngle * Math.PI / 180);
                const y = radius - (radius - 5) * Math.cos(currentAngle * Math.PI / 180);
                mark.style.cssText = `left:${x}px;top:${y}px;transform:rotate(${currentAngle}deg);`;
                container.appendChild(mark);

                if(i % 2 === 0) {
                    const label = document.createElement('div');
                    label.className = 'gauge-label';
                    const value = isTemperature 
                        ? config.temperature.min + (i * 6)
                        : i * 10;
                    label.textContent = value;
                    const labelX = radius + (radius - 10) * Math.sin(currentAngle * Math.PI / 180);
                    const labelY = radius - (radius - 10) * Math.cos(currentAngle * Math.PI / 180);
                    label.style.left = `${labelX}px`;
                    label.style.top = `${labelY}px`;
                    container.appendChild(label);
                }
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        window.onload = () => {
            createScaleMarks(document.querySelector('.temperature-gauge'), true);
            createScaleMarks(document.querySelector('.humidity-gauge'), false);
        }
    </script>
</body>
</html>